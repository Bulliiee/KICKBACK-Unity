using System;
using System.Collections;
using System.Collections.Generic;
using Unity.VisualScripting;
using UnityEngine;
using UnityEngine.SceneManagement;
using UnityEngine.UI;
using TMPro;

public class LobbyManager : MonoBehaviour
{
    [SerializeField] private GameObject LoginCanvas; // ?メ??? ?????
    [SerializeField] private GameObject LobbyCanvas; // ?リ? ?????
    [SerializeField] private Button LogoutBtn; // ?メ? ??? ???
    
    [Header("Lobby")]
    public GameObject ScrollViewLobbyList;  // ??? ???? ????? ???? ??????
    public GameObject UserListElement;      // ???? ??????? ??? ???? ???????
    public Button LobbyAllListBtn;          // ??? ???? ????? ???? ???

    [Header("Room")]
    public GameObject ScrollViewChannelList;    // ??? ?????
    public GameObject ChannelListElement;       // ??? ????? ???
    public ChannelListElement SelectedChannel;  // ????? ??? ?????

    void Start()
    {
        // TCPConnectionController.Instance.ConnectToServer();
        BusinessManager.Instance.ConnectToServer();
        BusinessManager.Instance.LobbyManagerScript = gameObject.GetComponent<LobbyManager>();
        
        // ?メ??? ??????? ?リ? ??????? ?‐?? ???? ???
        LoginCanvas = GameObject.FindWithTag("Login Canvas");
        LobbyCanvas = GameObject.FindWithTag("Lobby Canvas");
        ScrollViewLobbyList = GameObject.Find("User List");
        ScrollViewChannelList = GameObject.Find("Room List");

        //// ?????? ?メ??? ????? ???? ??? ????????? ???
        //GameObject logoutButtonObject = GameObject.Find("Logout Btn");
        //if (logoutButtonObject != null)
        //{
        //    LogoutBtn = logoutButtonObject.GetComponent<Button>();

        //    // ?メ??? ????? ??? ?????? ???
        //    if (LogoutBtn != null)
        //    {
        //        LogoutBtn.onClick.RemoveAllListeners(); // ???? ?????? ????
        //        LogoutBtn.onClick.AddListener(LobbyOut); // ???ワ? ?????? ???
        //    }
        //}
    }

    //public void LobbyOut()
    //{
    //    SceneManager.LoadScene("Login");

    //    // ?メ??? ????? ????, ?リ? ????? ??????
    //    //if (LoginCanvas != null)
    //        LoginCanvas.SetActive(true);
    //    //if (LobbyCanvas != null)
    //        LobbyCanvas.SetActive(false);

    //    // ??? ???? ??? ????
    //    TCPConnectManager.Instance.OnApplicationQuit();
    //    BusinessManager.Instance.OnApplicationQuit();
    //    DataManager.Instance.dataClear();
    //}
    
    // ??? ???? ???????
    public void getAllUsers(List<string> userList)
    {
        if(userList != null)
        {
            // ???? ????? ??? ??????(?????? ?ヨ?)
            Transform content = ScrollViewLobbyList.transform.Find("All Users Scroll View/Viewport/Content");
            // ???? ????? ????
            // TODO: ??????? ???
            foreach(Transform child in content) {
                Destroy(child.gameObject);
            }

            // ???? ??????? ??? ?????? ??????? ????
            GameObject[] userListElements = new GameObject[userList.Count];

            // ???? ????? ?????? ????????? ??? ??????
            //GameObject[] activeUserData = new GameObject[userList.Length];
            for (int i = 0; i < userList.Count; i++)
            {
                // ??? ????? ?????
                // if(userList[i] == DataManager.Instance.loginUserInfo.NickName)   // chk
                // {
                //     continue;
                // }
                // ??? ???? ?? ?ヨ? ????
                userListElements[i] = Instantiate(UserListElement);
                userListElements[i].transform.SetParent(content, false);
                // ???? ?????? ????
                UserListElement userListElementScript = userListElements[i].GetComponent<UserListElement>();
                userListElementScript.Nickname = userList[i];
                // ?????? ?????
                userListElementScript.UserNameText.text = userList[i];
            }

            // ???? ???? ?ワ? ???? ???????
            // ConnectedUserCount.text = "???? ?ワ?: " + userList.Length;
        }
    }
    
    [Serializable]
    class ChannelInfo
    {
        public int roomIndex;   // ?? ???
        public string roomName; // ?? ????
        public string mapName; // ?? ???
        public bool isOnGame; // ?????????? ?????
        public int roomUser; // ??? ??????????
    }
    
    // ?? ????? ???????
    public void getRoomList(List<string> roomList)
    {
        // ??? ????? ??? ??????(?????? ?ヨ?)
        Transform content = ScrollViewChannelList.transform.Find("Scroll View/Viewport/Content");
        // ???? ????? ????
        // TODO: ??????? ???
        foreach (Transform child in content)
        {
            Destroy(child.gameObject);
        }

        for(int i = 0; i < roomList.Count; i++)
        {   
            
            // ???? ?ワ? ?????? ?????? ???
            // if(channelList.data[i].isOnGame || channelList.data[i].cnt == 6)
            // {
            //     continue;
            // }

            //Debug.Log("?????: " + channelList.data[i].channelName);
            // ?????? ?????
            ChannelInfo roomInfo;
            if (i != roomList.Count - 1)
            {
                roomInfo = JsonUtility.FromJson<ChannelInfo>(roomList[i] + "}");
            }
            else
            {
                roomInfo = JsonUtility.FromJson<ChannelInfo>(roomList[i]);
            }
            Debug.Log(roomInfo.roomUser + "???? ?? ?ワ???");
            GameObject channelListElement = Instantiate(ChannelListElement);
            ChannelListElement channelListElementScript = channelListElement.GetComponent<ChannelListElement>();
            channelListElementScript.RoomIndex = roomInfo.roomIndex;
            channelListElementScript.RoomName = roomInfo.roomName;
            channelListElementScript.mapName = roomInfo.mapName;
            channelListElementScript.roomUser = roomInfo.roomUser;
            channelListElementScript.IsOnGame = roomInfo.isOnGame;
            
            // ?ヨ? ?????
            channelListElement.transform.SetParent(content, false);
        }
    }
    
    
    //
    // // ?? ????? ??? ??? ??
    // public void CreateChannelBtnClicked()
    // {
    //     CreateChannel.SetActive(true);
    // }
    //
    // // ?? ??????? ??? ??
    // public void JoinChannelBtnClicked()
    // {
    //     TCPConnectManager.Instance.joinChannel();   // chk
    // }
}
